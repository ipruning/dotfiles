#!/usr/bin/env bash

set -e
set -u
set -o pipefail

function logger() {
  local RED='\033[0;31m'
  local YELLOW='\033[1;33m'
  local GRAY='\033[0;90m'
  local NC='\033[0m'

  local message
  message=$1
  local loglevel
  loglevel=${2:-"INFO"}
  local loglevel_upper
  loglevel_upper=$(printf "%s" "$loglevel" | tr '[:lower:]' '[:upper:]')
  local timestamp
  timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  local color
  color=$GRAY

  case "$loglevel_upper" in
  "ERROR")
    color=$RED
    ;;
  "WARN")
    color=$YELLOW
    ;;
  "INFO")
    if [ "${DRY_RUN:-}" = true ]; then
      color=$YELLOW
    else
      color=$GRAY
    fi
    ;;
  *)
    loglevel="INFO"
    loglevel_upper="INFO"
    color=$GRAY
    ;;
  esac

  printf "${color}[%s] [%s] %s${NC}\n" "$timestamp" "$loglevel_upper" "$message"
}

if command -v brew &>/dev/null; then
  logger "Updating Homebrew..."
  brew update
  brew upgrade
  brew cleanup
  brew autoremove
fi

if command -v mise &>/dev/null; then
  logger "Updating mise..."
  mise upgrade
  mise prune --yes
  mise reshim
fi

if command -v gh &>/dev/null; then
  logger "Updating GitHub CLI extensions..."
  gh extension upgrade --all
fi

if command -v tldr &>/dev/null; then
  logger "Updating tldr pages..."
  tldr --update
fi

if command -v ya &>/dev/null; then
  logger "Updating ya packages..."
  ya pkg upgrade
fi

if command -v sprite &>/dev/null; then
  logger "Updating Sprite..."
  sprite upgrade
fi

if command -v amp &>/dev/null; then
  logger "Updating Amp Code..."
  amp update
fi

if command -v claude &>/dev/null; then
  logger "Updating Claude..."
  claude update
fi

if command -v opencode &>/dev/null; then
  logger "Updating OpenCode..."
  opencode upgrade
fi

if command -v pi &>/dev/null; then
  logger "Updating Pi Plugin..."
  pi update
fi

logger "Backing up all packages..."
host="$(hostname -s || true)"
host="${host:-unknown-host}"
host="${host//[^A-Za-z0-9._-]/-}"
mkdir -p "$HOME/dotfiles/generated/docs/$host"
if command -v brew &>/dev/null; then
  brew bundle dump --file="$HOME/dotfiles/generated/docs/$host/brew_dump.txt" --force
  brew leaves | LC_ALL=en_US.UTF-8 sort >"$HOME/dotfiles/generated/docs/$host/brew_leaves.txt"
  brew list --installed-on-request | LC_ALL=en_US.UTF-8 sort >"$HOME/dotfiles/generated/docs/$host/brew_installed.txt"
fi
if command -v gh &>/dev/null; then
  gh extension list | awk '{print $3}' | LC_ALL=en_US.UTF-8 sort >"$HOME/dotfiles/generated/docs/$host/gh_extensions.txt"
fi
if [ -d "/Applications" ]; then
  find /Applications -maxdepth 1 -name "*.app" -exec basename {} .app \; | LC_ALL=en_US.UTF-8 sort >"$HOME/dotfiles/generated/docs/$host/applications.txt"
fi
if [ -d "/Applications/Setapp" ]; then
  find /Applications/Setapp -maxdepth 1 -name "*.app" -exec basename {} .app \; | LC_ALL=en_US.UTF-8 sort >"$HOME/dotfiles/generated/docs/$host/setapp.txt"
fi
